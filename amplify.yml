version: 1
backend:
  phases:
    build:
      commands:
        # 캐시된 node_modules가 있다면 watcher 재빌드를 건너뜁니다
        - |
          if [ ! -f "node_modules/@parcel/watcher/index.js" ]; then
            npm ci --cache .npm --prefer-offline --legacy-peer-deps
            npm rebuild @parcel/watcher
          else
            npm ci --cache .npm --prefer-offline --legacy-peer-deps
          fi
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
frontend:
  phases:
    preBuild:
      commands:
        - |
          if [ ! -f "node_modules/@parcel/watcher/index.js" ]; then
            npm ci --legacy-peer-deps
            npm rebuild @parcel/watcher
          else
            npm ci --legacy-peer-deps
          fi
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - "**/*"
  cache:
    paths:
      - .npm/**/*
      - node_modules/**/*
      # watcher 바이너리를 명시적으로 캐시
      - node_modules/@parcel/watcher/**/*
